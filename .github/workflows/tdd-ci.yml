name: TDD Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: TDD ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ${{ matrix.node-version }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: ESLintã§ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯
      run: npm run lint

    - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: npm run test:unit

    - name: çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: npm run test:integration

    - name: E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: npm run test:e2e

    - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆ
      run: npm run coverage

    - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: ./coverage/lcov.info
        delete-old-comments: true

  quality-gate:
    name: å“è³ªã‚²ãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        npm run coverage
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ90%æœªæº€ã®å ´åˆã¯å¤±æ•—
        coverage=$(node -p "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json'));
          Math.min(
            coverage.total.lines.pct,
            coverage.total.functions.pct,
            coverage.total.branches.pct,
            coverage.total.statements.pct
          );
        ")
        echo "ç¾åœ¨ã®ã‚«ãƒãƒ¬ãƒƒã‚¸: ${coverage}%"
        if (( $(echo "$coverage < 90" | bc -l) )); then
          echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ90%æœªæº€ã§ã™ (${coverage}%)"
          exit 1
        fi
        echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ (${coverage}%)"

    - name: ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼
      run: |
        echo "## ğŸ§ª TDDãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”´ğŸŸ¢ğŸ”µ TDDã‚µã‚¤ã‚¯ãƒ«å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯TDDåŸå‰‡ã«å¾“ã£ã¦é–‹ç™ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY 